<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LC-3b Simulator</title>
        <link rel="stylesheet" href="/style.css" />
    </head>
    <body>
        <header>
            <h1 id="header_with_loading"><span class="loading">LC-3b (loading...)</span></h1>
        </header>

        <div class="main-container">
            <div class="editor-panel">
                <label for="program">LC-3b Assembly</label>
                <textarea id="program">; LC-3b Assembly Program
; Example: Add registers

ADD R1, R2, R0   ; R1 = R2 + R0
ADD R3, R1, #5   ; R3 = R1 + 5
ADD R4, R3, R1   ; R4 = R3 + R1
</textarea>
                <div class="button-row">
                    <button id="load_program" class="btn-primary">Load Program</button>
                    <button id="next_instruction" class="btn-secondary">Execute Next Instruction</button>
                </div>
            </div>

            <div class="computer-panel">
                <div class="pc-section">
                    <div class="panel-title">Program Counter</div>
                    <div class="pc-display">
                        <div class="pc-label">PC</div>
                        <div class="pc-value" id="pc-value">0x0000</div>
                    </div>
                </div>

                <div class="registers-section">
                    <div class="panel-title">Registers</div>
                    <div class="registers-grid">
                        <div class="register">
                            <span class="register-name">R0</span>
                            <span class="register-value" id="r0-value">0x0000</span>
                            <div class="register-tooltip" id="r0-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R1</span>
                            <span class="register-value" id="r1-value">0x0000</span>
                            <div class="register-tooltip" id="r1-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R2</span>
                            <span class="register-value" id="r2-value">0x0000</span>
                            <div class="register-tooltip" id="r2-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R3</span>
                            <span class="register-value" id="r3-value">0x0000</span>
                            <div class="register-tooltip" id="r3-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R4</span>
                            <span class="register-value" id="r4-value">0x0000</span>
                            <div class="register-tooltip" id="r4-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R5</span>
                            <span class="register-value" id="r5-value">0x0000</span>
                            <div class="register-tooltip" id="r5-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R6</span>
                            <span class="register-value" id="r6-value">0x0000</span>
                            <div class="register-tooltip" id="r6-tooltip"></div>
                        </div>
                        <div class="register">
                            <span class="register-name">R7</span>
                            <span class="register-value" id="r7-value">0x0000</span>
                            <div class="register-tooltip" id="r7-tooltip"></div>
                        </div>
                    </div>
                </div>

                <div class="status-section">
                    <div class="panel-title">Status</div>
                    <div class="status-item">
                        <span class="status-label">Program</span>
                        <span class="status-value" id="program-status">Not Loaded</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Instructions</span>
                        <span class="status-value" id="instruction-count">0</span>
                    </div>
                </div>

                <div class="memory-section">
                    <div class="panel-title">Memory</div>
                    <div class="memory-viewer" id="memory-viewer">
                        <div class="memory-placeholder">Load a program to view memory</div>
                    </div>
                </div>

                <details class="debug-section">
                    <summary class="panel-title debug-toggle">Emulator Debug Log</summary>
                    <div class="debug-log" id="debug-log"></div>
                    <button class="btn-clear" id="clear-debug-log">Clear</button>
                </details>
            </div>
        </div>

        <script type="module">
            import init, {
                new_computer,
                next_instruction,
                program_counter,
                register0,
                register1,
                register2,
                register3,
                register4,
                register5,
                register6,
                register7,
                read_memory,
                WasmCallbacksRegistry,
            } from "./lc3b.js";

            let computer = null;
            let instructionCount = 0;

            // Intercept console.log to redirect to debug pane
            const originalConsoleLog = console.log;
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                appendToDebugLog(args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' '));
            };

            function appendToDebugLog(message) {
                const debugLog = document.getElementById('debug-log');
                if (debugLog) {
                    const entry = document.createElement('div');
                    entry.className = 'debug-log-entry';
                    entry.textContent = message;
                    debugLog.appendChild(entry);
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }

            function clearDebugLog() {
                const debugLog = document.getElementById('debug-log');
                if (debugLog) {
                    debugLog.innerHTML = '';
                }
            }

            function formatHex(value) {
                return "0x" + value.toString(16).toUpperCase().padStart(4, "0");
            }

            function updatePCDisplay() {
                if (computer) {
                    const pc = program_counter(computer);
                    document.getElementById("pc-value").textContent = formatHex(pc);
                }
            }

            function formatBinary(value) {
                return value.toString(2).padStart(16, "0");
            }

            function formatSigned(value) {
                // Interpret as signed 16-bit
                if (value >= 0x8000) {
                    return (value - 0x10000).toString();
                }
                return value.toString();
            }

            function decodeInstruction(word) {
                const opcode = (word >> 12) & 0xF;
                const opcodeNames = [
                    "BR", "ADD", "LDB", "STB", "JSR", "AND", "LDW", "STW",
                    "RTI", "XOR", "???", "???", "JMP", "SHF", "LEA", "TRAP"
                ];
                return opcodeNames[opcode];
            }

            function updateMemoryViewer() {
                const viewer = document.getElementById("memory-viewer");
                if (!computer) {
                    viewer.innerHTML = '<div class="memory-placeholder">Load a program to view memory</div>';
                    return;
                }

                const pc = program_counter(computer);
                // Show 16 words centered on PC (PC-8 to PC+7)
                const startAddr = Math.max(0, pc - 8);
                const endAddr = Math.min(0xFFFF, startAddr + 15);

                let html = '';
                for (let addr = startAddr; addr <= endAddr; addr++) {
                    const value = read_memory(computer, addr);
                    const isPC = addr === pc;
                    const decoded = decodeInstruction(value);
                    html += `<div class="memory-row${isPC ? ' memory-row-pc' : ''}">
                        <span class="memory-addr">${formatHex(addr)}</span>
                        <span class="memory-value">${formatHex(value)}</span>
                        <span class="memory-decoded">${decoded}</span>
                    </div>`;
                }
                viewer.innerHTML = html;
            }

            function updateRegisterDisplay(index, value) {
                const el = document.getElementById(`r${index}-value`);
                if (el) {
                    el.textContent = formatHex(value);
                }

                const tooltip = document.getElementById(`r${index}-tooltip`);
                if (tooltip) {
                    tooltip.innerHTML = `
                        <div class="tooltip-row">
                            <span class="tooltip-label">Hex</span>
                            <span class="tooltip-value">${formatHex(value)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Decimal</span>
                            <span class="tooltip-value">${value}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Signed</span>
                            <span class="tooltip-value">${formatSigned(value)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Binary</span>
                            <span class="tooltip-value">${formatBinary(value)}</span>
                        </div>
                    `;
                }
            }

            function updateAllRegisters() {
                if (computer) {
                    updateRegisterDisplay(0, register0(computer));
                    updateRegisterDisplay(1, register1(computer));
                    updateRegisterDisplay(2, register2(computer));
                    updateRegisterDisplay(3, register3(computer));
                    updateRegisterDisplay(4, register4(computer));
                    updateRegisterDisplay(5, register5(computer));
                    updateRegisterDisplay(6, register6(computer));
                    updateRegisterDisplay(7, register7(computer));
                }
            }

            function updateInstructionCount() {
                document.getElementById("instruction-count").textContent = instructionCount;
            }

            function setStatus(loaded) {
                const el = document.getElementById("program-status");
                if (loaded) {
                    el.textContent = "Ready";
                    el.classList.add("ready");
                } else {
                    el.textContent = "Not Loaded";
                    el.classList.remove("ready");
                }
            }

            async function initializeSimulator() {
                await init();

                const header = document.getElementById("header_with_loading");
                header.innerHTML = "LC-3b Simulator";

                document
                    .getElementById("load_program")
                    .addEventListener("click", newComputerWithProgramLoaded);

                document
                    .getElementById("next_instruction")
                    .addEventListener("click", executeNextInstruction);

                document
                    .getElementById("clear-debug-log")
                    .addEventListener("click", clearDebugLog);
            }

            function newComputerWithProgramLoaded() {
                const programAssembly = document.getElementById("program").value;
                // Callback must not access computer while it's borrowed by next_instruction
                var callbacks = WasmCallbacksRegistry.new(() => {});
                computer = new_computer(programAssembly, callbacks);
                instructionCount = 0;
                updatePCDisplay();
                updateAllRegisters();
                updateInstructionCount();
                updateMemoryViewer();
                setStatus(true);
            }

            function executeNextInstruction() {
                if (computer) {
                    next_instruction(computer);
                    instructionCount++;
                    updatePCDisplay();
                    updateAllRegisters();
                    updateInstructionCount();
                    updateMemoryViewer();
                }
            }

            initializeSimulator().catch(console.error);
        </script>
    </body>
</html>
